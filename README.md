# Eラーニングコンテンツ類似度比較システム 要件定義書

## 1. 概要

本システムは、A社およびB社が提供するEラーニング学習コンテンツの名称を比較し、  
A社のコンテンツがB社のどのコンテンツに類似しているかを自動判定する。  

GeminiのEmbedding APIを利用して各コンテンツ名をベクトル化し、  
コサイン類似度により類似度を算出する。  

大量データ（A社：約90,000件、B社：約700件）を対象とするため、  
APIキーを複数利用した並列実行と途中再開機能を備える。

---

## 2. 目的

- A社コンテンツの網羅性・重複度・差分を定量的に分析可能にする  
- B社コンテンツとの類似度マッピングを自動生成し、比較作業を効率化  
- 長時間の処理でも安全に中断・再開できる仕組みを提供

---

## 3. システム構成

| 項目 | 内容 |
|------|------|
| 対象データ | A社：90,000件程度、B社：700件程度 |
| 入力形式 | CSV（1列のみ、各行にコンテンツ名） |
| 出力形式 | CSV（A社コンテンツ名、B社コンテンツ名、類似度） |
| 使用モデル | Gemini `text-embedding-004` |
| 開発言語 | Python 3.10以降 |
| 主なライブラリ | `google-generativeai`, `pandas`, `numpy`, `scikit-learn`, `python-dotenv`, `tqdm` |
| 並列実行 | Gemini APIキー4つをラウンドロビンで分散実行 |
| 環境変数管理 | `.env` ファイルによるAPIキー管理 |

---

## 4. 処理フロー

1. **初期化**
   - `.env`ファイルから4つのGemini APIキーを読み込む
   - ログ設定（ファイル出力＋コンソール出力）

2. **B社データの埋め込み**
   - 初回実行時のみEmbeddingを生成し、`b_embeddings.pkl` にキャッシュ
   - 2回目以降はキャッシュを再利用

3. **A社データの分割処理**
   - A社データを500件単位でチャンクに分割
   - 既に出力CSVに存在するタイトルはスキップ（途中再開対応）

4. **Embedding生成と類似度計算**
   - 各タイトルをGemini APIでEmbedding化
   - B社のEmbeddingとコサイン類似度を算出
   - 最も類似度が高いB社コンテンツを取得

5. **結果出力**
   - チャンク単位で `match_results.csv` に追記
   - 各チャンク終了時にログへ進捗出力

6. **ログ・監視**
   - APIキー別の使用回数を記録
   - 平均処理速度・残り時間を推定表示
   - すべての情報を `logs/run_YYYYMMDD_HHMMSS.log` に保存

---

## 5. 出力仕様

### 出力CSV（`match_results.csv`）

| 項目名 | 内容 |
|---------|------|
| A社コンテンツ名 | 比較対象となるA社のタイトル文字列 |
| B社コンテンツ名 | 最も類似したB社タイトル |
| 類似度 | コサイン類似度（0.0〜1.0、4桁小数） |

---

## 6. ログ仕様

### 出力内容例

```
14:02:15 [INFO] ===== E-Learning コンテンツ比較開始 =====
14:02:16 [INFO]  Loading cached B社 embeddings...
14:02:17 [INFO]  残り 89950 件を処理開始します。
14:02:17 [INFO]  Chunk 1 開始 (500 件)
14:04:01 [INFO]  Chunk done (500 items) | Time: 104.3s | Avg/item: 0.21s
14:04:01 [INFO]  Chunk 1 完了。進捗 500/89950 (0.6%) | 速度: 4.79件/秒 | 残り推定: 311分
14:04:01 [INFO]  API使用状況: 1f3a9b:125, 93cc2a:126, 42fe7c:124, 12aa88:125
```

---

## 7. エラー・再実行設計

| ケース | 対応内容 |
|--------|-----------|
| API呼び出し失敗 | 最大3回リトライ（指数バックオフ） |
| B社Embedding生成中断 | `b_embeddings.pkl` に部分保存 |
| 途中再実行 | 既存CSVを確認しスキップして再開 |
| ゼロベクトル処理 | 失敗時はゼロベクトルで継続（結果には低類似度として反映） |

---

## 8. パフォーマンス要件

| 項目 | 目標値 |
|------|--------|
| 1件あたり平均処理時間 | 0.2秒以下（4キー稼働時） |
| 並列実行数 | 最大4セッション（APIキー数） |
| チャンク単位保存 | 500件ごとにCSV追記 |
| メモリ使用量 | 約1.5GB（B社700件＋A社バッチ500件時） |

---

## 9. 運用・保守

| 項目 | 内容 |
|------|------|
| APIキー管理 | `.env` に格納（Git管理対象外） |
| ログ確認 | `logs/` ディレクトリに保存された最新ログを参照 |
| キャッシュ管理 | B社Embeddingキャッシュは初回作成後に再利用可能 |
| 再実行 | 前回途中までの出力CSVを維持したまま再起動可能 |

---

## 10. 拡張予定

| 項目 | 概要 |
|------|------|
| 類似度しきい値設定 | 一定値以下の結果を空欄または除外 |
| 完全非同期化 | `asyncio.Semaphore` による並列強化 |
| 通知機能 | Slack／LINEへの進捗通知 |
| ダッシュボード | Streamlitで進捗可視化 |

---

## 11. ファイル構成例

```
project_root/
├─ compare_contents.py
├─ .env
├─ A_company.csv
├─ B_company.csv
├─ match_results.csv
├─ b_embeddings.pkl
└─ logs/
   └─ run_20251101_140215.log
```

---

## 12. セキュリティ要件

- `.env` ファイルは `.gitignore` に登録し、ソース管理から除外する  
- APIキーをコード内に直接記述しない  
- 出力CSVに個人情報を含まないことを確認  

---

## 13. 成果物一覧

| ファイル名 | 説明 |
|-------------|------|
| `compare_contents.py` | 類似度算出スクリプト |
| `b_embeddings.pkl` | B社コンテンツのEmbeddingキャッシュ |
| `match_results.csv` | A社⇔B社の類似度マッピング結果 |
| `logs/run_*.log` | 実行時の詳細ログ |
| `.env` | Gemini APIキー格納ファイル |
