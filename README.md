# CSV項目類似度比較ツール

## 1. 概要

本システムは、入力CSV1および入力CSV2が提供する項目名を比較し、  
入力CSV1の項目が入力CSV2のどの項目に類似しているかを自動判定する。  

GeminiのEmbedding APIを利用して各項目名をベクトル化し、  
コサイン類似度により類似度を算出する。  

大量データ（入力CSV1：約90,000件、入力CSV2：約700件）を対象とするため、  
APIキーを複数利用した並列実行と途中再開機能を備える。

---

## 2. 目的

- 入力CSV1項目の網羅性・重複度・差分を定量的に分析可能にする  
- 入力CSV2項目との類似度マッピングを自動生成し、比較作業を効率化  
- 長時間の処理でも安全に中断・再開できる仕組みを提供

---

## 3. システム構成

| 項目 | 内容 |
|------|------|
| 対象データ | 入力CSV1：90,000件程度、入力CSV2：700件程度 |
| 入力形式 | CSV（1列のみ、各行に項目名） |
| 出力形式 | CSV（入力CSV1項目名、入力CSV2項目名、類似度） |
| 使用モデル | Gemini `text-embedding-004` |
| 開発言語 | Python 3.10以降 |
| 主なライブラリ | `google-generativeai`, `pandas`, `numpy`, `scikit-learn`, `python-dotenv`, `tqdm` |
| 並列実行 | Gemini APIキー4つをラウンドロビンで分散実行 |
| 環境変数管理 | `.env` ファイルによるAPIキー管理 |
| 依存関係管理 | `pyproject.toml` と `uv.lock` |

---

## 4. 処理フロー

1. **初期化**
   - `.env`ファイルから4つのGemini APIキーを読み込む
   - ログ設定（ファイル出力＋コンソール出力）

2. **入力CSV2データの埋め込み**
   - 初回実行時のみEmbeddingを生成し、`input2_embeddings.pkl` にキャッシュ
   - 2回目以降はキャッシュを再利用

3. **入力CSV1データの分割処理**
   - 入力CSV1データを500件単位でチャンクに分割
   - 既に出力CSVに存在するタイトルはスキップ（途中再開対応）

4. **Embedding生成と類似度計算**
   - 各タイトルをGemini APIでEmbedding化
   - 入力CSV2のEmbeddingとコサイン類似度を算出
   - 最も類似度が高い入力CSV2項目を取得

5. **結果出力**
   - チャンク単位で `match_results.csv` に追記
   - 各チャンク終了時にログへ進捗出力

6. **ログ・監視**
   - APIキー別の使用回数を記録
   - 平均処理速度・残り時間を推定表示
   - すべての情報を `logs/run_YYYYMMDD_HHMMSS.log` に保存

---

## 5. 出力仕様

### 出力CSV（`match_results.csv`）

| 項目名 | 内容 |
|---------|------|
| 入力CSV1項目名 | 比較対象となる入力CSV1のタイトル文字列 |
| 入力CSV2項目名 | 最も類似した入力CSV2項目 |
| 類似度 | コサイン類似度（0.0〜1.0、4桁小数） |

---

## 6. ログ仕様

### 出力内容例

```
14:02:15 [INFO] ===== CSV項目類似度比較ツール 開始 =====
14:02:16 [INFO]  Loading cached 入力CSV2 embeddings...
14:02:17 [INFO]  残り 89950 件を処理開始します。
14:02:17 [INFO]  Chunk 1 開始 (500 件)
14:04:01 [INFO]  Chunk done (500 items) | Time: 104.3s | Avg/item: 0.21s
14:04:01 [INFO]  Chunk 1 完了。進捗 500/89950 (0.6%) | 速度: 4.79件/秒 | 残り推定: 311分
14:04:01 [INFO]  API使用状況: 1f3a9b:125, 93cc2a:126, 42fe7c:124, 12aa88:125
```

---

## 7. エラー・再実行設計

| ケース | 対応内容 |
|--------|-----------|
| API呼び出し失敗 | 最大3回リトライ（指数バックオフ） |
| 入力CSV2Embedding生成中断 | `input2_embeddings.pkl` に部分保存 |
| 途中再実行 | 既存CSVを確認しスキップして再開 |
| ゼロベクトル処理 | 失敗時はゼロベクトルで継続（結果には低類似度として反映） |

---

## 8. パフォーマンス要件

| 項目 | 目標値 |
|------|--------|
| 1件あたり平均処理時間 | 0.2秒以下（4キー稼働時） |
| 並列実行数 | 最大4セッション（APIキー数） |
| チャンク単位保存 | 500件ごとにCSV追記 |
| メモリ使用量 | 約1.5GB（入力CSV2 700件＋入力CSV1バッチ500件時） |

---

## 9. 運用・保守

| 項目 | 内容 |
|------|------|
| APIキー管理 | `.env` に格納（Git管理対象外） |
| ログ確認 | `logs/` ディレクトリに保存された最新ログを参照 |
| キャッシュ管理 | 入力CSV2Embeddingキャッシュは初回作成後に再利用可能 |
| 再実行 | 前回途中までの出力CSVを維持したまま再起動可能 |

---

## 10. 拡張予定

| 項目 | 概要 |
|------|------|
| 類似度しきい値設定 | 一定値以下の結果を空欄または除外 |
| 完全非同期化 | `asyncio.Semaphore` による並列強化 |
| 通知機能 | Slack／LINEへの進捗通知 |
| ダッシュボード | Streamlitで進捗可視化 |

---

## 11. セットアップ

### 1. uvのインストール

Pythonのパッケージマネージャーである`uv`をインストールします。

```bash
pip install uv
```

### 2. 仮想環境の作成とアクティベート

プロジェクトルートに移動し、`uv`で仮想環境を作成します。

```bash
uv venv
```

### 3. 依存関係のインストール

`pyproject.toml`に定義されている依存関係をインストールします。

```bash
uv pip install
```

---

## 12. 実行方法

```bash
uv run python csv_content_matcher.py input1.csv input2.csv
```

---

## 13. ファイル構成例

```
project_root/
├─ csv_content_matcher.py
├─ pyproject.toml
├─ uv.lock
├─ .env
├─ input1.csv
├─ input2.csv
├─ match_results.csv
├─ input2_embeddings.pkl
└─ logs/
   └─ run_20251101_140215.log
```

---

## 14. セキュリティ要件

- `.env` ファイルは `.gitignore` に登録し、ソース管理から除外する  
- APIキーをコード内に直接記述しない  
- 出力CSVに個人情報を含まないことを確認  

---

## 15. 成果物一覧

| ファイル名 | 説明 |
|-------------|------|
| `csv_content_matcher.py` | 類似度算出スクリプト |
| `input2_embeddings.pkl` | 入力CSV2項目のEmbeddingキャッシュ |
| `match_results.csv` | 入力CSV1⇔入力CSV2の類似度マッピング結果 |
| `logs/run_*.log` | 実行時の詳細ログ |
| `.env` | Gemini APIキー格納ファイル |
| `pyproject.toml` | プロジェクトのメタデータと依存関係を定義 |
| `uv.lock` | 依存関係の正確なバージョンをロックするファイル |